{{ $yamlBlock := .Inner | transform.Unmarshal }}
{{ with $yamlBlock }}
{{ $id := delimit (shuffle (split (md5 "foo") "" )) "" }}
<div class="openapi">
{{ range $path, $methods := .paths }}
  {{ range $method, $items := $methods }}
    <div class="endpoint">
      <span class="endpoint-method regular-font upper bold-text method-{{ $method }}">{{ $method }}</span>
      <span class="endpoint-path">{{ $path }}</span>
    </div>
    <div class="openapi-description regular-font">
      {{ $items.description | markdownify }}
    </div>

    {{ with .parameters }}
      {{- template "renderParameters" dict "content" .}}
    {{ end }}

    {{ with .requestBody }}
      {{- template "renderRequestBody" dict "content" .}}
    {{ end }}

    {{ with .responses }}
      {{- template "renderResponses" dict "content" . "id" $id }}
    {{ end }}
    
  {{end}}
{{end}}
</div>
{{ end }}




{{- define "renderParameters" }}
  {{ $content := .content }}
  <div class="openapi-parameters regular-font">
    <div class="openapi-table-title">
      Path Parameters
    </div>
    <div>
      <ul class="openapi-table">
          {{ range $k, $v := $content }}
            {{- template "renderParameter" dict "prop" $v.name "value" $v "category" "path" }}
          {{ end }}
      </ul>
    </div>
  </div>

  <div class="openapi-parameters regular-font">
    <div class="openapi-table-title">
      Query Parameters
    </div>
    <div>
      <ul class="openapi-table">
          {{ range $k, $v := $content }}
            {{- template "renderParameter" dict "prop" $v.name "value" $v "category" "query" }}
          {{ end }}
      </ul>
    </div>
  </div>
{{ end }}

{{- define "renderRequestBody" }}
  {{ $content := .content }}
  <div class="openapi-parameters regular-font">
    <div class="openapi-table-title">
      Request Body
    </div>
    <div>
      <ul class="openapi-table">
        {{ range $k, $v := $content.content }}
          {{ range $prop, $value := $v.schema.properties}}
            {{- template "renderProperty" dict "prop" $prop "value" $value }}
          {{ end }}
        {{ end }}
      </ul>
    </div>
  </div>
{{ end }}

{{- define "renderResponses" }}
  {{ $id := .id }}
  {{ $content := .content }}
  <div class="responses regular-font">
    <div class="openapi-table-title">Responses</div>
    <div>
      <div class="response-codes">
      {{ range $status, $info := $content }}
          <button class="response-code" id="response-{{ $id }}-{{ $status }}">
            {{ $status }}
          </button>
      {{ end }}
      </div>
      {{ range $status, $info := $content }}
          <div class="openapi-response-body hidden" id="response-{{ $id }}-{{ $status }}">
          {{ if $info.content }}
          <div class="openapi-description regular-font">
            {{ $info.description | markdownify }}
          </div>
            <div class="openapi-table-title">Response Body</div>
            <ul class="openapi-table">
              {{ range $k, $v := $info.content }}
                {{ range $prop, $value := $v.schema.properties}}
                  {{- template "renderProperty" dict "prop" $prop "value" $value }}
                {{ end }}
              {{ end }}
            </ul>
          {{ else }}
          <div class="openapi-description regular-font">
            {{ $info.description | markdownify }}
          </div>
          {{ end }}
          </div>
      {{ end }}
    </div>
  </div>
{{ end }}

{{- define "renderParameter" }}
  {{ $category := .category }}
  {{ $prop := .prop }}
  {{ $value := .value }}
  {{ if eq $category $value.in }}
    {{ $structName := "" }}
      <li class="openapi-table-row regular-font">
        {{ $ref := index $value "$ref" }}
        {{ if $ref }}
          {{$structName = split $ref "/" | last 1 }}
        {{ end }}
          <div class="openapi-prop collapsed">
            <code class="bold-text">{{ $prop }}{{ if $value.required }}*{{ end }}</code>  <span style="font-weight: bold;">{{ if $ref }} object {{ else }} {{ $value.schema.type }} {{ end }}</span>
            {{ $description := $value.description | markdownify }}
            <div class="openapi-prop-content hidden">
              <p class="regular-font">{{ $description }}</p>
              {{ with $ref }}
                {{ $componentsFile := index site.Data "components" }}
                {{ $struct := index $componentsFile.schemas $structName }}
                <span class="openapi-table show-children bold-text"> Show Children</span>
                <ul class="openapi-table children">
                  {{ range $k, $v := $struct.properties }}
                    {{- template "renderProperty" dict "prop" $k "value" $v }}
                  {{ end }}
                </ul>
              {{ end }}
            </div>
          </div>
      </li>
  {{ end }}
{{ end }}


{{- define "renderProperty" }}
  {{ $prop := .prop }}
  {{ $value := .value }}
  {{ $structName := "" }}
    <li class="openapi-table-row regular-font">
      {{ $ref := index $value "$ref" }}
      {{ if $ref }}
        {{$structName = split $ref "/" | last 1 }}
      {{ end }}
      <div class="openapi-prop collapsed">
        <code class="bold-text">{{ $prop }}</code>  <span style="font-weight: bold;">{{ if $ref }} object {{ else }} {{ $value.type }} {{ end }} </span>
        {{ $description := $value.description | markdownify }}
        <div class="openapi-prop-content hidden">
          <p class="regular-font">{{ $description }}</p>
        {{ with $ref }}
          {{ $componentsFile := index site.Data "components" }}
          {{ $struct := index $componentsFile.schemas $structName }}
          <span class="openapi-table show-children bold-text"> Show Children</span>
          <ul class="openapi-table hidden">
            {{ range $k, $v := $struct.properties }}
              {{- template "renderProperty" dict "prop" $k "value" $v }}
            {{ end }}
          </ul>
        {{ end }}
        </div>
      </div>
    </li>
{{ end }}
